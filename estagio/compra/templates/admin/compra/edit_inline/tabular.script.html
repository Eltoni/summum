<script type="text/javascript">
    /*----------------------------------------------------------------------------------------------------------------------------------
    A primeira função, no blur do item, acessa a url a view get_price para buscar o preço do item e atribuir ao campo Valor Unitário...
    A segunda funçao, no keyUp do quantidade, calcula o valorTotal do item.
    ----------------------------------------------------------------------------------------------------------------------------------*/

    $(document).ready(function(){
        var valorUnitario;
        var id;

        // executa a função quando a select de produto perder o foco
        $("#id_itenscompra_set-{{ forloop.counter0 }}-produto").blur(function(){
            // armazena na variável id o produto selecionado na select
            id = $("#id_itenscompra_set-{{ forloop.counter0 }}-produto").val();
            $.ajax({
                type: "GET",                                                            // Determina o método http, GET, POST …
                url: "/get_valor_unitario/"+id,                                         // url declarada no urls.py
                dataType: "json",                                                       // tipo de dados que a url vai retornar
                success: function(retorno){                                             // Caso tenhamos sucesso a função segue em frente
                    $.each(retorno, function(i, produtos){                              // Faz um laço e pega todos os itens do objeto “retorno”
                        // armazena na variável o valor de venda do produto
                        var a = number_format(produtos.fields['preco'],2, ',', '.');
                        // seta o valor obtido acima no campo valor unitário
                        valorUnitario = produtos.fields['preco'];{
                            $('input[name="itenscompra_set-{{ forloop.counter0 }}-valor_unitario"]').val(a);
                    });
                }
            });
        });

        // Quantidade
        // Executa enquanto o usuário digita os dados
        $('input[name=itenscompra_set-{{ forloop.counter0 }}-quantidade]').keyup(function () {
            var a = parseFloat($("input[name=itenscompra_set-{{ forloop.counter0 }}-quantidade]").val());
            var b = unformat($("input[name=itenscompra_set-{{ forloop.counter0 }}-valor_unitario]").val());
            var result = a * b;

            // seta o valor total do item de compra no campo correspondente
            $('#input[name="itenscompra_set-{{ forloop.counter0 }}-valor_total"]').val(number_format(result,2, ',', '.'));
        }).keyup();

    });
</script>